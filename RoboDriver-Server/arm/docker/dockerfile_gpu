FROM nvidia/cuda:11.8.0-base-ubuntu20.04

# 配置时区（避免 apt 安装阻塞）
ENV DEBIAN_FRONTEND=noninteractive
RUN ln -fs /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone

# 安装基础依赖 + FFmpeg（从官方 PPA）
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        wget \
        bzip2 \
        ca-certificates \
        libgl1-mesa-glx \
        libglib2.0-0 \
        libsm6 \
        libxext6 \
        libxrender1 \
        tzdata && \
    wget -qO- https://ppa.ubuntucontent.net/jonathonf/ffmpeg-4/ubuntu/gpgkey | tee /etc/apt/trusted.gpg.d/ffmpeg-4.asc && \
    echo "deb https://ppa.ubuntucontent.net/jonathonf/ffmpeg-4/ubuntu/ $(. /etc/os-release && echo $UBUNTU_CODENAME) main" > /etc/apt/sources.list.d/ffmpeg.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends ffmpeg && \
    dpkg-reconfigure -f noninteractive tzdata && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# 验证 NVENC（依赖宿主机挂载的驱动）
RUN ffmpeg -hide_banner -encoders | grep nvenc

# 安装 Miniconda（直接配置到 base 环境）
RUN wget -q https://mirrors.bfsu.edu.cn/anaconda/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh && \
    bash miniconda.sh -b -p /opt/miniconda && \
    rm miniconda.sh

# 初始化 Conda 并配置基础环境
ENV PATH="/opt/miniconda/bin:$PATH"
RUN conda config --set always_yes yes && \
    conda config --add channels conda-forge && \
    conda clean -afy && \
    # 接受 Conda 条款（避免运行时提示）
    conda init bash && \
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main && \
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r

# 直接在 base 环境中安装依赖（通过 environment.yml 或 requirements.txt）
WORKDIR /app
COPY environment.yml .
RUN conda env update --name base --file environment.yml && \
    conda clean -afy

# 安装 Python 依赖（使用国内镜像加速）
COPY robot_uploader-1.0.0-py3-none-any.whl /tmp/
COPY requirements.txt .
RUN pip install --no-cache-dir \
    /tmp/robot_uploader-1.0.0-py3-none-any.whl && \
    pip install --no-cache-dir -r requirements.txt \
    -i https://pypi.tuna.tsinghua.edu.cn/simple

# 环境变量配置
ENV PATH="/opt/miniconda/bin:$PATH" \
    TZ=Asia/Shanghai \
    NVIDIA_VISIBLE_DEVICES=all \
    NVIDIA_DRIVER_CAPABILITIES=compute,utility,video

# 创建应用目录
RUN mkdir -p /app/code
WORKDIR /app/code

EXPOSE 8088
# 直接运行命令（无需 conda activate，因为已在 base 环境）
CMD ["sh", "-c", "if [ -f \"/app/code/dist/operating_platform_server_test.bin\" ]; then \
    /app/code/dist/operating_platform_server_test.bin --log-output=stdout; \
    else \
    python operating_platform_server_test.py --log-output=stdout; \
    fi"]
